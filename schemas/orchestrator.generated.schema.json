{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "RobotFarmTurn",
  "description": "Structured agent turn payload.",
  "type": "object",
  "properties": {
    "assignments": {
      "description": "Assignments payload when intent=ASSIGN_TASKS.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/Assignment"
      }
    },
    "blocked": {
      "description": "Blocked tasks payload when intent=BLOCKED.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/BlockedEntry"
      }
    },
    "completed": {
      "description": "Completed tasks payload when intent=COMPLETE_TASKS.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/OrchestratorCompletion"
      }
    },
    "details": {
      "description": "Expanded details supporting the summary.",
      "type": "string"
    },
    "intent": {
      "$ref": "#/$defs/OrchestratorIntent"
    },
    "queue": {
      "description": "Optional hints the program may apply to the dispatcher.",
      "type": "object",
      "properties": {
        "insert_before_message_id": {
          "description": "Queue item ID to insert before.",
          "type": "integer",
          "format": "int64"
        },
        "priority_bump": {
          "description": "Relative priority bump to apply.",
          "type": "integer",
          "format": "int64"
        },
        "target": {
          "description": "Queue target (e.g., 'ws3' or 'orchestrator').",
          "type": "string"
        }
      },
      "additionalProperties": false,
      "required": [
        "priority_bump",
        "insert_before_message_id",
        "target"
      ]
    },
    "summary": {
      "description": "One-line summary of the turn.",
      "type": "string"
    },
    "target": {
      "description": "Orchestrator must set their worker_id (e.g., 'ws1') when messaging a worker; workers should provide null.",
      "type": "string"
    }
  },
  "additionalProperties": false,
  "required": [
    "target",
    "intent",
    "summary",
    "details",
    "assignments",
    "completed",
    "blocked",
    "queue"
  ],
  "$defs": {
    "Assignment": {
      "description": "Assignment payload detailing tasks for the worker.",
      "type": "object",
      "properties": {
        "acceptance": {
          "description": "Acceptance criteria for the assignment.",
          "type": "string"
        },
        "steps": {
          "description": "Concrete steps the worker should follow.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "task_slug": {
          "description": "Slug of the assigned story/task.",
          "type": "string"
        },
        "task_title": {
          "description": "Short title describing the assignment.",
          "type": "string"
        }
      },
      "additionalProperties": false,
      "required": [
        "task_slug",
        "task_title",
        "steps",
        "acceptance"
      ]
    },
    "BlockedEntry": {
      "description": "Blocked entry describing impediments.",
      "type": "object",
      "properties": {
        "proposed_unblock_steps": {
          "description": "Suggestions for unblocking the task.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "reason": {
          "description": "Explanation of why work cannot proceed.",
          "type": "string"
        },
        "requires_merge_resolution": {
          "description": "Whether a merge conflict must be resolved.",
          "type": "boolean"
        },
        "task_slug": {
          "description": "Slug of the blocked task.",
          "type": "string"
        }
      },
      "additionalProperties": false,
      "required": [
        "task_slug",
        "reason",
        "requires_merge_resolution",
        "proposed_unblock_steps"
      ]
    },
    "OrchestratorCompletion": {
      "description": "Completion entry for a task (orchestrator variant, includes optional answer).",
      "type": "object",
      "properties": {
        "answer": {
          "description": "Structured answer payload when answer_required was true.",
          "type": "string"
        },
        "commit_summary": {
          "description": "Short summary describing the changes for auto-commit messages. Aim for <= 72 characters.",
          "type": "string",
          "maxLength": 120,
          "minLength": 3
        },
        "notes": {
          "description": "Completion notes or highlights.",
          "type": "string"
        },
        "open_questions": {
          "description": "Follow-up questions, if any.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "task_slug": {
          "description": "Slug of the task that was completed.",
          "type": "string"
        }
      },
      "additionalProperties": false,
      "required": [
        "task_slug",
        "notes",
        "open_questions",
        "answer",
        "commit_summary"
      ]
    },
    "OrchestratorIntent": {
      "description": "Intent values for the orchestrator agent.",
      "type": "string",
      "enum": [
        "ASSIGN_TASKS",
        "STATUS_UPDATE",
        "ACK_PAUSE"
      ]
    }
  }
}